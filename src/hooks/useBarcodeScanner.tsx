import { useState, useCallback } from 'react';
import { BarcodeScanner } from '@capacitor-community/barcode-scanner';
import { Capacitor } from '@capacitor/core';
import { useToast } from '@/hooks/use-toast';
import { supabase } from '@/integrations/supabase/client';

interface ScanResult {
  hasContent: boolean;
  content: string;
}

interface ScannedProduct {
  id: string;
  nome: string;
  sku_interno: string;
  codigo_barras: string;
  quantidade_atual: number;
  estoque_minimo: number;
  status: string;
  categoria?: string;
  preco_venda?: number;
  ultima_movimentacao?: string;
}

interface ScanHistory {
  codigo: string;
  produto?: string;
  timestamp: string;
  found: boolean;
}

export function useBarcodeScanner() {
  const [isScanning, setIsScanning] = useState(false);
  const [lastScanResult, setLastScanResult] = useState<string>('');
  const [scannedProduct, setScannedProduct] = useState<ScannedProduct | null>(null);
  const [scanHistory, setScanHistory] = useState<ScanHistory[]>([]);
  const [loading, setLoading] = useState(false);
  
  const { toast } = useToast();
  const isNative = Capacitor.isNativePlatform();
  
  console.log('üîß useBarcodeScanner: Hook inicializado', { isNative });

  // Verificar e solicitar permiss√µes
  const checkPermissions = async (): Promise<boolean> => {
    console.log('üîç useBarcodeScanner: Verificando plataforma...', { isNative });
    
    if (!isNative) {
      console.log('‚ùå useBarcodeScanner: N√£o √© plataforma nativa');
      toast({
        title: "Scanner n√£o dispon√≠vel",
        description: "O scanner de c√≥digo de barras s√≥ funciona em dispositivos m√≥veis",
        variant: "destructive"
      });
      return false;
    }

    try {
      console.log('üîç useBarcodeScanner: Verificando permiss√µes...');
      const status = await BarcodeScanner.checkPermission({ force: true });
      console.log('‚úÖ useBarcodeScanner: Status das permiss√µes:', status);
      
      if (status.granted) {
        return true;
      } else if (status.denied) {
        toast({
          title: "Permiss√£o negada",
          description: "√â necess√°rio permitir o acesso √† c√¢mera para usar o scanner",
          variant: "destructive"
        });
        return false;
      } else {
        // Se n√£o tem permiss√£o, solicitar novamente
        const newStatus = await BarcodeScanner.checkPermission({ force: true });
        return newStatus.granted;
      }
    } catch (error) {
      console.error('‚ùå useBarcodeScanner: Erro ao verificar permiss√µes:', error);
      toast({
        title: "Erro de permiss√£o",
        description: "N√£o foi poss√≠vel verificar as permiss√µes da c√¢mera",
        variant: "destructive"
      });
      return false;
    }
  };

  // Buscar produto no banco de dados
  const buscarProduto = async (codigo: string): Promise<ScannedProduct | null> => {
    try {
      const { data, error } = await supabase
        .from('produtos')
        .select(`
          id,
          nome,
          sku_interno,
          codigo_barras,
          quantidade_atual,
          estoque_minimo,
          status,
          categoria,
          preco_venda,
          ultima_movimentacao
        `)
        .eq('codigo_barras', codigo)
        .eq('ativo', true)
        .single();

      if (error && error.code !== 'PGRST116') {
        throw error;
      }

      return data as ScannedProduct;
    } catch (error) {
      console.error('Erro ao buscar produto:', error);
      return null;
    }
  };

  // Adicionar ao hist√≥rico
  const adicionarAoHistorico = (codigo: string, produto?: string, found: boolean = true) => {
    const novoItem: ScanHistory = {
      codigo,
      produto,
      timestamp: new Date().toISOString(),
      found
    };

    setScanHistory(prev => [novoItem, ...prev.slice(0, 9)]); // Manter apenas os 10 mais recentes
  };

  // Processar resultado do scan
  const processarScan = async (codigo: string) => {
    setLoading(true);
    
    try {
      const produto = await buscarProduto(codigo);
      
      if (produto) {
        setScannedProduct(produto);
        adicionarAoHistorico(codigo, produto.nome, true);
        
        toast({
          title: "Produto encontrado!",
          description: `${produto.nome} - ${produto.quantidade_atual} unidades`,
        });
      } else {
        setScannedProduct(null);
        adicionarAoHistorico(codigo, 'Produto n√£o encontrado', false);
        
        toast({
          title: "Produto n√£o encontrado",
          description: `C√≥digo ${codigo} n√£o foi encontrado no sistema`,
          variant: "destructive"
        });
      }
      
      setLastScanResult(codigo);
    } catch (error) {
      console.error('Erro ao processar scan:', error);
      toast({
        title: "Erro ao processar c√≥digo",
        description: "Ocorreu um erro ao buscar o produto",
        variant: "destructive"
      });
    } finally {
      setLoading(false);
    }
  };

  // Iniciar scanner
  const startScan = async () => {
    console.log('üöÄ useBarcodeScanner: Iniciando scanner...');
    
    const hasPermission = await checkPermissions();
    if (!hasPermission) {
      console.log('‚ùå useBarcodeScanner: Sem permiss√µes, cancelando...');
      return;
    }

    try {
      console.log('üì± useBarcodeScanner: Configurando scanner...');
      setIsScanning(true);
      
      // Ocultar o conte√∫do da p√°gina
      document.body.classList.add('scanner-active');
      await BarcodeScanner.hideBackground();
      console.log('üì∑ useBarcodeScanner: Iniciando captura...');

      const result: ScanResult = await BarcodeScanner.startScan();
      console.log('üìä useBarcodeScanner: Resultado do scan:', result);
      
      if (result.hasContent && result.content) {
        await processarScan(result.content);
      }
    } catch (error) {
      console.error('‚ùå useBarcodeScanner: Erro no scanner:', error);
      toast({
        title: "Erro no scanner",
        description: `Ocorreu um erro ao usar o scanner: ${error}`,
        variant: "destructive"
      });
    } finally {
      console.log('üîÑ useBarcodeScanner: Finalizando scanner...');
      await stopScan();
    }
  };

  // Parar scanner
  const stopScan = async () => {
    try {
      setIsScanning(false);
      await BarcodeScanner.showBackground();
      await BarcodeScanner.stopScan();
      document.body.classList.remove('scanner-active');
    } catch (error) {
      console.error('Erro ao parar scanner:', error);
    }
  };

  // Busca manual por c√≥digo
  const buscarManualmente = async (codigo: string) => {
    if (!codigo.trim()) {
      toast({
        title: "C√≥digo inv√°lido",
        description: "Digite um c√≥digo v√°lido para buscar",
        variant: "destructive"
      });
      return;
    }

    await processarScan(codigo.trim());
  };

  // Limpar resultado
  const limparResultado = useCallback(() => {
    setScannedProduct(null);
    setLastScanResult('');
  }, []);

  return {
    isScanning,
    isNative,
    loading,
    lastScanResult,
    scannedProduct,
    scanHistory,
    startScan,
    stopScan,
    buscarManualmente,
    limparResultado,
    processarScan
  };
}